# Visual experience exerts an instructive role on cortical feedback inputs to primary visual cortex.
by Radhika Rajan, Rodrigo F. Dias, Xinyun Zhang, Margarida Baeta, Nikos Malakasis, Julijana Gjorgjieva and Leopoldo Petreanu

## Overview
Code writen by Xinyun Zhang (xy.zhang@tum.de) and Nikos Malakasis (nikos.malakasis@tum.de).

This repository contains the computational models developed for the study. The two models simulate how visual experience shapes: 

1. feedforward receptive fields and their orientation selectivity, of neurons in the latero-medial visual cortex (LM), through inputs from the primary visual cortex (V1).
2. feedback receptive fields and their orientation selectivity, of neurons in the primary visual cortex (V1), through inputs from the latero-medial visual cortex (LM).

## Repository structure 
Code developed using **Python 3.11.13**.

Required libraries: Numpy, Matplotlib, Scipy, tqdm, gwp, seaborn, pandas, starbars, open-cv.

To install, run: 
`pip install numpy matplotlib scipy tqdm gwp seaborn pandas starbars opencv-python`

Code files:

- simfeedfoward.py
  
This is the code for the simulation of the feedforward model, where orientation selective feedforward inputs from the primary visual cortex (V1) shape the receptive field of neurons in the latero-medial visual cortex (LM).

- generateffRF.py

This is the code for the generation of the receptive fields of LM neurons, based on the arrangement and orientation selectivity of the synapses
  
- processffmodelresults.py

This is the code for the analysis of the results generated by the feedforward model. Specifically, the RF tilt is calculated for multiple LM neurons over all 3 groups and statistically compared across the groups. 

- simfeedback.py

This is the code for the simulation of the feedback model, where orientation selective feedback inputs from the latero-medial visual cortex (LM) shape the feedback receptive field of neurons in the primary visual cortex (V1).

- processfbmodelresults.py

This is the code for the analysis of the results generated by the feedback model. Specifically, the ratio of boutons in the 135 degree bowtie is calculated for multiple V1 neurons over all 3 groups and statistically compared across the groups. 

## Running the Code

First of all, to run the code, you need clone this repository to your computer using the command:

`git clone https://github.com/comp-neural-circuits/feedforward-and-feedback-synaptic-organisation.git`

or through github's graphical interphase. Then, after installing the required libraries mentioned above, follow the steps described in the following sections.

### Feedforward Model and Analysis
To run the feedforward model, execute in the **code** folder the following command:

`python simfeedforward.py -G <setting> -T <trials> -S <seed>`

- "setting" / "-G" -> "GR45", "GR135" or "CTRL": Select goggle experiment simulation type. Type = string.
  
- "trials" / "-T" -> <number of trials>: Select the amount of simulations to run. Type = integer.
  
- "seed" / "-S" -> <seed number>: Set the seed to control randomness. Type = integer.

The code outputs 6 files per simulation run, in the folder **../generated_model_outputs/FF_model_outputs/GR45 or CTRL or GR135**, depending on the selected setting. The generated files are:

- "trial<k>_ori.npy" -> Orientations of established synapses at the end of the simulation

- "trial<k>_coord.npy" -> Coordinates of established synapses at the end of the simulation

- "trial<k>_weight.npy" -> Weights of established synapses at the end of the simulation

- "trial<k>_ori_t0.npy" -> Orientations of established synapses at the start of the simulation
  
- "trial<k>_coord_t0.npy" -> Coordinates of established synapses at the start of the simulation
  
- "trial<k>__syns_in_vis_space.png" -> Plot of final distribution of established synapses in visual space

where k stands for index of trial run.

To analyze the outputs, you first need to generate the receptive field per trial. To do so, execute in the **code** folder the following command:

`python generateffRF.py -G <setting> -T <trials> -S <seed> -F <folder>`

- "setting" / "-G" -> "GR45", "GR135" or "CTRL": Select goggle experiment simulation type. Type = string.
- "trials" / "-T" -> <number of trials>: Select the amount of simulations to run. Type = integer.
- "seed" / "-S" -> <seed number>: Set the seed to control randomness. Type = integer.
- "folder" / "-F" -> "generated" or "provided". Type = string.

By "generated" or "provided", you can choose to either execute the code on the results of the simulations that you run yourself (generated), or on the simulation results that we provide on the repository, together with the code(provided).

The code outputs 2 files per simulation run, in the folder **../generated_model_outputs/FF_model_outputs/GR45 or CTRL or GR135** if "generated" or in the folder **../provided_model_outputs/FF_model_outputs/new_outputs/GR45 or CTRL or GR135** if "provided", depending on the selected setting. The generated files are:

- "trial<k>_rf.npy" -> The receptive field of the each neuron after the simulation.
- "trial<k>_generated_rf.png' -> Plot showing the receptive field of the each neuron after the simulation.

where k stands for index of trial run.

Now that the receptive field is generated, you can run the analysis on the receptive field's tilt, provided that you have generated at least one receptive field per setting. Otherwise, you can always run the analysis using the already generated receptive fields that we provide(see option below). To do so, execute in the **code** folder the following command:

`python processffmodelresults.py -T <trials> -S <seed> -F <folder>`

- "trials" / "-T" -> <number of trials>: Select the amount of simulations to run. Type = integer.
- "seed" / "-S" -> <seed number>: Set the seed to control randomness. Type = integer.
- "folder" / "-F" -> "generated" or "provided" or "provided_new". Type = string.

 By "generated" or "provided", you can choose to either execute the code on the results of the simulations that you run yourself (generated), or on the simulation results that we provide on the repository, together with the code(provided). "provided_new" can be used to test the RFs generated by the "provided" option in the "generateffRF.py" code file that were not already there.

The code outputs 1 file, in the folder **../generated_model_outputs/FF_model_outputs/** if "generated", in the folder **../provided_model_outputs/FF_model_outputs/new_outputs/** if "provided" or in the folder **../provided_model_outputs/FF_model_outputs/new_outputs/from_new/** if "provided_new". The generated files are:

- "LM_FFRF_angle_comparison_for_<trials>_trials.png" -> Boxplots for the RF tilt of all three groups, statistically compared.

### Feedback Model and Analysis
The run the feedback model, execute in the **code** folder the following command:

`python simfeedback.py -G <setting> -T <trials> -S <seed> -O <soma_orientation>`

- "setting" / "-G" -> "GR45", "GR135" or "CTRL": Select goggle experiment simulation type. Type = string.

- "trials" / "-T" -> <number of trials>: Select the amount of simulations to run. Type = integer.
  
- "seed" / "-S" -> <seed number>: Set the seed to control randomness. Type = integer.
  
- "soma_orientation" / "-O" -> 0, 2, 4 or 6. Corresponds to somatic orientation preference. Type = integer.

The code outputs 6 files per simulation run, in the folder **../generated_model_outputs/FB_model_outputs/FB_{CTRL or GR45 or GR135}_soma_ori_{0 or 2 or 4 or 6}**, depending on the selected setting and somatic orientation preference. The generated files are:

- "trial<k>_ori.npy" -> Orientations of established synapses at the end of the simulation
- "trial<k>_coord.npy" -> Coordinates of established synapses at the end of the simulation
- "trial<k>_weight.npy" -> Weights of established synapses at the end of the simulation
- "trial<k>_ori_t0.npy" -> Orientations of established synapses at the start of the simulation
- "trial<k>_coord_t0.npy" -> Coordinates of established synapses at the start of the simulation
- "trial<k>__syns_in_vis_space.png" -> Plot of final distribution of established synapses in visual space

where k stands for index of trial run.

Given enough simulations per setting and per somatic orientation (at least 100 per), or by utilizing the "provided" outputs by the relevant setting, you can run the analysis for the ratio of boutons in the 135 degree bowtie. To do so, execute in the **code** folder the following command:

`python processfbmodelresults.py -T <trials> -S <seed> -F <folder>`

- "trials" / "-T" -> <number of trials>: Select the amount of simulations to run. Type = integer.
- "seed" / "-S" -> <seed number>: Set the seed to control randomness. Type = integer.
- "folder" / "-F" -> "generated" or "provided".

The code outputs 1 file, in the folder **../generated_model_outputs/FB_model_outputs/** if "generated" or in the folder **../provided_model_outputs/FB_model_outputs/new_outputs/** if "provided". The generated files are:

- "V1_FBRF_LM_bouton_ratio_in_135_deg_bowtie.png" -> Boxplots for the ratio of boutons in the 135 degree bowtie of all three groups, statistically compared.

In the case of the "provided" option, use explicitly the following command:

`python processfbmodelresults.py -T 100 -S 12345 -F "provided"`

as the files provided are exactly as many as required to run it as such. The seed can be changed.
